<html>
<!--AD_DND-->
<head>
<title>Group Spam System</title>
</head>

<body bgcolor=#ffffff text=#000000>
<h2>Group Spam System</h2>

part of the <a href="index">ArsDigita Community System</a>
by <a href="mailto:ahmeds@mit.edu/">Sarah Ahmed</a>

<hr>

<ul>
<li>User directory:  /groups/$short_name/spam-index
<li>Admin directory:  /groups/admin/$short_name/spam-index
<li>Data model:  subsection within 
<a href="/doc/sql/display-sql?url=/user-groups.sql&package_key=acs-core">/packages/acs-core/user-groups.sql</a> and <a href="/doc/sql/display-sql?url=/user-groups.sql&package_key=acs-core">/packages/acs-core/community-core.sql</a>
<li>Procedures:  within /tcl/user-group-defs<br>
     <ul>
         <li><a href=proc-one?proc_name=send_one_group_spam_message>send_one_group_spam_message</a>
         <li><a href=proc-one?proc_name=send_all_group_spam_messages>send_all_group_spam_messages</a>
         <li><a href=proc-one?proc_name=group_spam_removal_blurb>group_spam_removal_blurb</a>
         <li><a href=proc-one?proc_name=bozo_filter_blurb>bozo_filter_blurb</a>
     </ul>
<li>Related modules: <a href="spam">Spam System</a> and <a href="email-handler">automatic email processing</a>
</ul>

<h3>The Big Picture</h3>

This system is designed to handle group level spamming. The site-wide administrator or the group-level administrator can set the group spam policy to be "open", "closed", or "wait". For open spam policy, any member of the group can spam other members/administrators of the group. For "wait" spam policy, spam generated by group members needs to be approved by the group administrator first. For "closed" spam policy, only the group administrators are allowed to spam the group. For any spam policy, spams sent from group admin pages are immediately approved.

<h3>Under the Hood</h3>
<P>

<ul>

<li>The system allows each group member to set his/her own email preferences; i.e. a group member will receive group spams only if he sets his personal profile to receive spams. Personal email profile can be set at the user pages. Also, a <a href=proc-one?proc_name=group_spam_removal_blurb>group spam removal blurb</a> is added at the bottom of each group spam.

<p>

<li>The system also employs a user-level bozo filter. At the bottom of every group spam ( or any spam for that matter), a <a href=proc-one?proc_name=bozo_filter_blurb>bozo filter blurb</a> is (can be)appended, which is used to set or unset a filter against the specific sender. This filter can be used to prevent a user from any site-wide email from the sender.   

<p>
<li>The system supports personalization of emails - in the message body, one can use variables like &#60first_names> , &#60last_name>, &#60email>,&#60group_name>,&#60admin_email>, which are respectively replaced by the receiver's first name, last name, email, the group's name and the group's administrative email.

<p>
 
<li>We keep a history of all the spam we've sent to users in the <code>group_spam_history</code> table, which also serves as a queue to send approved but unsent mails.

<p>

<li>Forms that allow a publisher to spam generate a new spam_id for the blank form; this way a double click does not result in a spam being sent twice.

<p>

<li>When the administrator resets the group spam policy to be "open", all currently "waiting" spams are immediately approved and sent out.

<p>

<li>The system distinguishes between three different states of a spam - "approved", "disapproved", "waiting" ( approved_p is "t", "f", null respectively). In the group admin main page, it only lists spams that are "waiting" for administrator's approval. However, the spam-history page logs all group spams from which the administrator can also approve a previously dispproved email.    

</ul>

<p>

<h3>Data Model</h3>

This system consists of three tables. 

The group_spam_history table holds the spamming log for this group. This log is used both for displaying the group/personal email history and as a queue to send approved but unsent emails.

<blockquote>
<pre>

create table group_spam_history (
	spam_id			integer primary key,
	group_id		references user_groups not null,
	sender_id		references users(user_id) not null,
	sender_ip_address	varchar(50) not null,
	from_address		varchar(100),
	subject			varchar(200),
 	body			clob,
	send_to			varchar (50) default 'members' check (send_to in ('members','administrators')), 
	creation_date		date not null,
	-- approved_p matters only for spam policy='wait'
	-- approved_p = 't' indicates administrator approved the mail 
	-- approved_p = 'f' indicates administrator disapproved the mail, so it won't be listed for approval again
	-- approved_p = null indicates the mail is not approved/disapproved by the administrator yet 
	approved_p		char(1) default null check (approved_p is null or approved_p in ('t','f')),
	send_date		date,
	-- this holds the number of intended recipients
	n_receivers_intended	integer default 0,
	-- we'll increment this after every successful email
	n_receivers_actual	integer default 0
);
</pre>
</blockquote>

<P>
The group_member_email_preferences table retains email preferences of members that belong to a particular group.
 
<blockquote>
<pre>
create table group_member_email_preferences (
	group_id		references user_groups not null,
	user_id			references users not null ,
	dont_spam_me_p		char (1) default 'f' check(dont_spam_me_p in ('t','f')),
	primary key (group_id, user_id)  
);
</pre>
</blockquote> 

The user_user_bozo_filter table contains information to implement a personalized "bozo filter". Any user ( origin_user_id) can restrain any emails from some other user ( target_user_id ). This table is not specific to a group.

<pre>
<blockquote> 
create table user_user_bozo_filter (
	origin_user_id	references users not null,
	target_user_id	references users not null,
	primary key (origin_user_id, target_user_id)
);
</pre>
</blockquote> 


<h3>Legal Transactions</h3>
From the group administration pages, the administrator can 

<ul>
<li>Set the group spam policy
<li>Send spam to group members
<li>Send spam to group administrators
<li>View spam history of the group
<li>View individual spam 
<li>Approve/dispprove a specific spam
</ul>
<P>

From the user pages, a group member can 

<ul>
<li>Set his/her persoanl email preference
<li>Send spam to group members
<li>Send spam to group administrators
<li>View his/her own spam history
<li>View individual spam 
</ul>
<P>

<p>

<hr>

<a href=mailto:ahmeds@mit.edu><address>ahmeds@mit.edu</address></a>
</body>
</html>







